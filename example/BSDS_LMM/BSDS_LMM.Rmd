---
title: "BSDSモデルによる線形変量効果モデル(BSDS-LMM)の推定"
author: "Ph.D. Ohkubo Yusaku (ROIS-DS & Institute of Statistical Mathematics) {y-ohkubo[--]ism.ac.jp}"
date: "3/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
枝特異的方向性淘汰モデル(branch-specific directional selection; 以下、BSDS)は種間系統比較法(phylogenetic comparative method)の一種で、系統樹における一部の枝で方向性淘汰を経た生物の形質を分析するために開発されました。
このドキュメントでは、仮想の形質データを題材にRとStanで実際にBSDSモデルを使った回帰分析を実行する方法について紹介します。


__なお回帰ではなく(説明変数がない）、祖先形質(MRCA)、進化率(ev)、選択圧の強さ(k)などマクロ進化に関わるパラメータそのものを推定したい場合は、以下を参照してください。__


## 下準備
### 必要パッケージのインストール
以下のコードでは、{ape},{rstan}{dummies}の3つのパッケージに依存しています。事前にインストールし、読み込んでおきます。
```{r eval=FALSE, warning=FALSE, include=TRUE}
install.packages(c("ape", "rstan", "dummies"))
```

```{r include=TRUE}
library(ape)
library(rstan)
library(dummies)
```


Stanのインストールがうまくいかない場合は、下記の公式ドキュメントを参照してください。
https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started-(Japanese)


### 必要な関数の準備
BSDSモデルをStanで実行するには、各個体の形質値、説明変数、種名のインデックス、系統樹のトポロジーと枝長、など多くのデータを受け渡す必要があります。そこで、これらのデータを一括してStanに渡すリスト形式に変換できるようあらかじめ関数を定義しておくと便利です。
```{r}
# define data-arrangement function
BSDSLMM_data<- function(phylo, y, X, Z, D_edge){
  len_phylo<- length(phylo$edge.length)
  N_tip<- len_phylo - phylo$Nnode +1
  branch_len<- phylo$edge.length
  tree_obj<- as.matrix(phylo$edge)
  MRCA_ij<- matrix(0, N_tip, N_tip) ## i,j elements correspond to the location of their MRCA in the tree
  
  for(i in 1:N_tip){
    for(j in i:N_tip){
      MRCA_ij[i,j]<- MRCA_ij[j,i]<- getMRCA(phylo, tip=c(i,j))
    }
  }
  
  dat<- list(N=length(y), N_sp=N_tip, 
             len_phylo=len_phylo, branch_len=branch_len, tree_obj=tree_obj, MRCA_ij=MRCA_ij,
             y=y, X=X, Z=dummy(Z), D_edge=D_edge, D=ncol(X))
  
  return (dat)
}
```


## 実行例
### データの読み込み
まず、題材となるデータを読み込み、構造を確認します。

```{r load_data}
data<- read.csv("BSDS_LMM_sample.csv")
summary(data)
Y<- data$Y
X<- as.matrix(data$X)
sp_ID<- (data$sp_ID)
```

Yに各個体(i=1,2,...N_sample)の形質値、Xに説明変数(今回は1次元)、sp_IDに各個体の種ID(1,2,...N_sp)を格納しています。


次に系統樹を読み込みます。ここでは、{ape}パッケージの関数を用いてNewick形式で記録された系統樹を読み込みます。
```{r}
phylo<- read.tree("BSDS_LMM_tree")
plot(phylo)
axisPhylo()
phylo$edge # tree構造:[,1]の親種から[,2]の子孫種へエッジが伸びている
```

また、方向性淘汰が生じたと思われる箇所を指定します。例えば、「原生種t10が、t1, t6, t9の共通祖先(sp19)と分岐した直後から方向性淘汰を受けるようになった」と仮定します。この場合、phylo$edgeにおいて「sp19からsp10」に伸びる枝、すなわち[18,]が該当する箇所になります。

```{r}
D_edge<- 18
```


最後に、これらのデータを先の関数でリスト形式に変換します。

```{r, eval=T,}
dat<- BSDSLMM_data(phylo, Y, X, sp_ID, D_edge)
```

警告が出ますが、無視して構いません。

### Stanの設定
Stanコードのファイル名を渡し(scr)、MCMCのサンプリング(ite)とwarmup(war)の回数、マルコフ連鎖の本数(cha)を指定します。


parには、推定するパラメータを指定します(オプション）。
説明変数の回帰係数を知りたいだけならbetaだけでも良いですが、WAICなどを計算するにはlog_likelihoodも必要になります。
__なお祖先種の状態(MRCA),進化率(ev),淘汰圧の強さ(k)を指定することもできますが、混合効果モデル(LMM)では識別性(identifiability)の問題が生じるようです。したがって、ランダム効果に関わるパラメータは周辺化してしまうことをお勧めします。__

マルチコアCPUの場合、最後のオプションを有効にすることで並列計算を実行することができ時間の節約になります。
```{r}
scr<-"stan_BSDS_LMM.stan"
war<- 5000
ite<- 25000
cha<- 2
par<- c("beta", "log_likelihood")
options(mc.cores = parallel::detectCores())
```

### サンプリングの開始
いよいよ、MCMCで事後分布からのサンプリングを行います。
```{r, eval=TRUE, warning=FALSE, include=TRUE}
fit_BSDS<- stan(file = scr, model_name = scr, data = dat, pars = par, chains = cha, 
          warmup = war, iter = ite, thin = 10, control = list(adapt_delta=0.95))
```
サンプリングの実行後にDivergent transitionやmaximum treedepthの警告が表示される際には、下記を参考にadapt_deltaなどを調節します。
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup

## 結果の出力
__MCMCが収束していることを保証するため、必ずtraceplot()やR_hatを確認しましょう。__
print()関数で、R_hatも含めた要約統計量の一覧を得ることができます。
```{r, eval=TRUE,include=TRUE}
print(fit_BSDS)
```

```{r, eval=TRUE}
traceplot(fit_BSDS)
```

その他{shinystan}では、マルコフ連鎖の診断や事後分布の可視化など優れたツールを提供しています。

### WAICの計算
```{r,eval=F, warning=FALSE, include=TRUE}
install.packages(loo)
library(loo)
waic(extract(fit_BSDS)$log_likelihood)
```


## References
大久保, 沓掛, 小泉 (2021)."枝特異的な方向性淘汰の推定について", March 17. 第68日本生態学会全国大会(https://esj.ne.jp/meeting/abst/68/D01-12.html)  
Ohkubo, Kutsukake, Koizumi (under review) "Evaluating a strength of directional selection using a novel branch-specific directional selection (BSDS) model of phylogenetic comparative method"
